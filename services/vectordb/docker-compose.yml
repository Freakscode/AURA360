version: "3.9"

services:
  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    ports:
      - "6333:6333" # REST
      - "6334:6334" # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]

  grobid:
    image: lfoppiano/grobid:0.7.2
    restart: unless-stopped
    environment:
      - GROBID_OPTS=--max-connection=10 --max-threads=10
    ports:
      - "8070:8070"
      - "8071:8071"

  api:
    build:
      context: .
      args:
        EXTRAS: "gcs"
    depends_on:
      - qdrant
      - redis
      - grobid
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_GRPC=${QDRANT_GRPC}
      - BROKER_URL=redis://redis:6379/0
      - RESULT_BACKEND=redis://redis:6379/1
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_VERSION=${EMBEDDING_VERSION:-2025.10.27}
      - EMBEDDING_DIM=384
      - VECTOR_DISTANCE=cosine
      - VECTOR_COLLECTION_NAME=${VECTOR_COLLECTION_NAME:-holistic_memory}
      - GROBID_URL=http://grobid:8070
      # Autenticación GCP moderna (ADC)
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/adc.json
      - GOOGLE_CLOUD_PROJECT=${GCS_PROJECT:-aura-360-471711}
      - GCS_PROJECT=${GCS_PROJECT:-aura-360-471711}
      # Opcional: si el bucket es requester-pays
      # - GCS_USER_PROJECT=${GCS_USER_PROJECT}
    volumes:
      # Montar solo ADC credentials (método moderno, más seguro)
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/adc.json:ro
      - .:/app:ro
    working_dir: /app
    command: ["uvicorn", "vectosvc.api.http:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "2"]
    ports:
      - "8001:8000"

  worker:
    build:
      context: .
      args:
        EXTRAS: "gcs"
    depends_on:
      - qdrant
      - redis
      - grobid
    environment:
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_GRPC=${QDRANT_GRPC}
      - BROKER_URL=redis://redis:6379/0
      - RESULT_BACKEND=redis://redis:6379/1
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_VERSION=${EMBEDDING_VERSION:-2025.10.27}
      - EMBEDDING_DIM=384
      - VECTOR_DISTANCE=cosine
      - VECTOR_COLLECTION_NAME=${VECTOR_COLLECTION_NAME:-holistic_memory}
      - GROBID_URL=http://grobid:8070
      # Autenticación GCP moderna (ADC)
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/adc.json
      - GOOGLE_CLOUD_PROJECT=${GCS_PROJECT:-aura-360-471711}
      - GCS_PROJECT=${GCS_PROJECT:-aura-360-471711}
      # Opcional: requester-pays
      # - GCS_USER_PROJECT=${GCS_USER_PROJECT}
      # AWS credentials
      - AWS_SHARED_CREDENTIALS_FILE=/root/.aws/credentials
      - AWS_CONFIG_FILE=/root/.aws/config
    volumes:
      # Montar solo ADC credentials (método moderno, más seguro)
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/adc.json:ro
      # AWS credentials
      - ${HOME}/.aws:/root/.aws:ro
      - .:/app:ro
    working_dir: /app
    command: ["celery", "-A", "vectosvc.worker.tasks.celery", "worker", "--loglevel=info", "--concurrency=2"]

  vectordb-consumer:
    build:
      context: ..
      dockerfile: vectordb/Dockerfile
      args:
        EXTRAS: "gcs"
    depends_on:
      - qdrant
      - redis
      - grobid
    environment:
      - MESSAGING_BACKEND=${MESSAGING_BACKEND:-kafka}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:29092}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_GRPC=${QDRANT_GRPC}
      - BROKER_URL=redis://redis:6379/0
      - RESULT_BACKEND=redis://redis:6379/1
      - DEFAULT_EMBEDDING_MODEL=${DEFAULT_EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_VERSION=${EMBEDDING_VERSION:-2025.10.27}
      - EMBEDDING_DIM=384
      - VECTOR_DISTANCE=cosine
      - VECTOR_COLLECTION_NAME=${VECTOR_COLLECTION_NAME:-holistic_memory}
      - GROBID_URL=http://grobid:8070
      # Autenticación GCP moderna (ADC)
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/adc.json
      - GOOGLE_CLOUD_PROJECT=${GCS_PROJECT:-aura-360-471711}
      - GCS_PROJECT=${GCS_PROJECT:-aura-360-471711}
    volumes:
      # Montar solo ADC credentials (método moderno, más seguro)
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/adc.json:ro
      - .:/app:ro
    working_dir: /app
    command: ["python", "-m", "vectosvc.kafka.consumer"]
    restart: unless-stopped

volumes:
  qdrant_storage:
